name: Build and Deploy

on:
  push:
    branches:
      - production

env:
  REGISTRY: 10.0.0.226:32346
  IMAGE_NAME: resume-site

jobs:
  build-and-deploy:
    runs-on: [self-hosted, kubernetes, lab]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build -f backend/Dockerfile -t $REGISTRY/$IMAGE_NAME:${{ github.sha }} .
          docker tag $REGISTRY/$IMAGE_NAME:${{ github.sha }} $REGISTRY/$IMAGE_NAME:latest

      - name: Push to registry
        run: |
          docker push $REGISTRY/$IMAGE_NAME:${{ github.sha }}
          docker push $REGISTRY/$IMAGE_NAME:latest

      - name: Copy TLS certificate secret
        run: |
          # Copy the PostgreSQL TLS CA certificate from database namespace
          kubectl get secret postgresql-tls-ca -n database -o json | \
            jq 'del(.metadata.resourceVersion, .metadata.uid, .metadata.creationTimestamp) | .metadata.namespace = "resume-site"' | \
            kubectl apply -f -

      - name: Deploy to Kubernetes with Helm
        run: |
          helm upgrade --install resume-site ./helm \
            --create-namespace \
            --namespace resume-site \
            --set image.tag=latest \
            --set secrets.cerebrasApiKey="${{ secrets.CEREBRAS_API_KEY }}" \
            --set secrets.geminiApiKey="${{ secrets.GEMINI_API_KEY }}" \
            --set postgresql.username="${{ secrets.POSTGRES_USERNAME_RESUME }}" \
            --set postgresql.password="${{ secrets.POSTGRES_PASSWORD_RESUME }}" \
            --wait \
            --timeout 5m

      - name: Clean up old images
        run: |
          docker image prune -f

      - name: Build summary
        run: |
          echo "âœ… Deployed successfully to Kubernetes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Details:**" >> $GITHUB_STEP_SUMMARY
          echo "- Service: resume-site" >> $GITHUB_STEP_SUMMARY
          echo "- Image: \`$REGISTRY/$IMAGE_NAME:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Ingress: \`resume.grizzly-endeavors.com\`" >> $GITHUB_STEP_SUMMARY
